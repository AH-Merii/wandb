version: 2.1

orbs:
  slack: circleci/slack@4.12.5

parameters:
  python_version:
    description: "Python version"
    type: string
    default: "3.8"
  go_version:
    description: "Go version"
    type: string
    default: "1.21.4"

commands:
  install_go:
    description: "Install Go with the specified version and system"
    parameters:
      version:
        description: "Go version"
        type: string
        default: << pipeline.parameters.go_version >>
      system:
        description: "OS"
        type: enum
        enum: ["linux-amd64", "darwin-amd64"]
    steps:
      - run:
          name: Install Go
          command: |
            wget https://go.dev/dl/go<<parameters.version>>.<<parameters.system>>.tar.gz
            tar -C /usr/local -xzf go<<parameters.version>>.<<parameters.system>>.tar.gz
            PATH=/usr/local/go/bin:$PATH
            go version
          no_output_timeout: 1m


executors:
  test-server:
    docker:
      - image: cimg/python:<< parameters.python_version >>
      - image: us-central1-docker.pkg.dev/wandb-production/images/local-testcontainer:<< parameters.server_tag >>
        auth:
          username: _json_key
          password: $GCP_SERVICE_ACCOUNT_JSON_DECODED
        environment:
          CI: 1
          WANDB_ENABLE_TEST_CONTAINER: true
    parameters:
      python_version:
        description: "Python version"
        type: string
      server_tag:
        description: "Test server repository tag"
        type: string
        default: master
    resource_class: xlarge
    working_directory: /mnt/ramdisk

jobs:
  test:
    description: "Run tests against test server"
    parameters:
      python_version:
        description: "Python version"
        type: string
        default: << pipeline.parameters.python_version >>
    executor:
      name: test-server
      python_version: << parameters.python_version >>
    steps:
      - checkout
      - install_go:
          system: "linux-amd64"
      - run:
          name: Check Python version
          command: |
            python --version
            go version
      - slack/notify:
          event: fail
          template: basic_fail_1
          mentions: "@channel"
          channel: $SLACK_SDK_NIGHTLY_CI_CHANNEL


workflows:
  all-tests:
    jobs:
      - test:
          matrix:
            parameters:
               python_version: ["3.7", "3.8", "3.9", "3.10", "3.11", "3.12"]
